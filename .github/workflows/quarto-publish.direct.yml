name: Quarto Site Deploy (Direct Push - No Artifacts)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write # Need write permission to push to gh-pages
  pages: write # Need write permission to trigger Pages rebuild

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      - name: Switch runner state to main branch
        shell: pwsh
        run: |
          # Self-hosted runners keep state between runs
          # The deploy step switches branches, corrupting subsequent checkouts
          if (Test-Path ".git") {
            Write-Host "Resetting runner git state..."
            git fetch origin main --force
            git checkout -B main origin/main --force
            git clean -fdx
            Write-Host "Runner state reset to origin/main"
          }

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main # Explicitly checkout main branch (fixes self-hosted runner state issues)
          fetch-depth: 1 # Shallow clone is sufficient for gh-pages force-push
          clean: true # Ensure clean checkout

      - name: Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2
        # Uses latest stable Quarto version automatically

      - name: Render Quarto Project
        shell: pwsh
        run: |
          Write-Host "Cleaning previous build artifacts..."
          Remove-Item -Recurse -Force .quarto -ErrorAction SilentlyContinue
          Remove-Item -Recurse -Force docs -ErrorAction SilentlyContinue
          Remove-Item -Recurse -Force _freeze -ErrorAction SilentlyContinue

          # Debug: Show what _quarto.yml contains
          Write-Host "=== _quarto.yml website.title ==="
          Get-Content "_quarto.yml" | Select-String -Pattern "title:" | Select-Object -First 2
          Write-Host "=== End of title check ==="

          Write-Host "Rendering Quarto project..."
          quarto render --to html

          # Debug: Show generated title in README.html
          Write-Host "=== Generated README.html title ==="
          Get-Content "docs/README.html" | Select-String -Pattern "<title>" | Select-Object -First 1
          Write-Host "=== End of generated title check ==="

          Write-Host "Verifying output directory..."
          if (Test-Path "docs") {
            $htmlFiles = Get-ChildItem "docs" -Filter "*.html" -Recurse
            Write-Host "Generated $($htmlFiles.Count) HTML files"
            
            # Check if navigation.json was copied
            if (Test-Path "docs/navigation.json") {
              Write-Host "âœ“ navigation.json found in output"
            } else {
              Write-Warning "âš  navigation.json not found in output"
            }
          } else {
            Write-Error "âœ— docs directory not found after rendering"
            exit 1
          }

      - name: Deploy to gh-pages branch
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        shell: pwsh
        run: |
          Write-Host "Deploying to gh-pages branch..."

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Save docs and .gitignore.gh-pages to temp location (outside repo)
          $tempDir = "$env:TEMP\gh-pages-deploy-$(Get-Random)"
          New-Item -ItemType Directory -Path $tempDir -Force | Out-Null
          Copy-Item -Path "docs\*" -Destination $tempDir -Recurse -Force
          Copy-Item -Path ".gitignore.gh-pages" -Destination $tempDir -Force -ErrorAction SilentlyContinue
          Write-Host "âœ“ Saved build output to: $tempDir"

          # Delete local gh-pages-deploy branch if it exists from previous run
          git branch -D gh-pages-deploy 2>$null

          # Create fresh orphan branch (no history = no case conflicts)
          git checkout --orphan gh-pages-deploy

          # Clear everything
          git rm -rf . 2>$null
          Get-ChildItem -Force | Where-Object { $_.Name -ne '.git' } | Remove-Item -Recurse -Force

          # Copy build output to repo root
          Copy-Item -Path "$tempDir\*" -Destination . -Recurse -Force
          Write-Host "âœ“ Copied build files to repo root"

          # Use gh-pages specific .gitignore (from main branch)
          if (Test-Path ".gitignore.gh-pages") {
            Move-Item -Path ".gitignore.gh-pages" -Destination ".gitignore" -Force
          } elseif (-not (Test-Path ".gitignore")) {
            # Fallback: fetch from main if not in temp
            git show main:.gitignore.gh-pages > .gitignore 2>$null
          }
          Write-Host "âœ“ Applied gh-pages .gitignore"

          # Cleanup temp (ignore errors - OS will clean eventually)
          Remove-Item $tempDir -Recurse -Force -ErrorAction SilentlyContinue

          # Stage all files
          git add -A
          git commit -m "ðŸš€ Deploy site - $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -m "From commit: $env:GITHUB_SHA"

          # Debug: Show commit info
          Write-Host "=== New commit info ==="
          git log -1 --oneline
          Write-Host "==="

          # Force push directly (don't delete first - just force update)
          Write-Host "Force pushing to gh-pages..."
          git push origin gh-pages-deploy:gh-pages --force --verbose 2>&1

          # Verify push worked
          Write-Host "Verifying push..."
          git fetch origin gh-pages
          $remoteCommit = git rev-parse origin/gh-pages
          $localCommit = git rev-parse HEAD
          Write-Host "Local commit: $localCommit"
          Write-Host "Remote gh-pages commit: $remoteCommit"

          Write-Host "âœ“ Site deployed to gh-pages branch!"
