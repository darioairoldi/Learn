<!-- Sidebar styling and fixes -->
<style>
/* Home link special styling - make it white and prominent but allow collapse */
.sidebar .nav-link[href="index.qmd"],
.sidebar .sidebar-item-text[href="index.qmd"],
.sidebar a[href="index.qmd"],
.sidebar-navigation .sidebar-item-text[href="index.qmd"],
#quarto-sidebar .sidebar-item-text[href="index.qmd"] {
  font-weight: 600 !important;
  font-size: 1.1rem !important;
  color: white !important;
  background: linear-gradient(135deg, #2780e3 0%, #1967d2 100%) !important;
  border: 2px solid #2780e3 !important;
  margin-bottom: 1rem !important;
  padding: 0.8rem 1rem !important;
  border-radius: 12px !important;
  box-shadow: 0 3px 8px rgba(39, 128, 227, 0.3) !important;
  transition: all 0.3s ease !important;
  /* Remove display: block to allow collapsible functionality */
}

.sidebar .nav-link[href="index.qmd"]:hover,
.sidebar .sidebar-item-text[href="index.qmd"]:hover,
.sidebar a[href="index.qmd"]:hover,
.sidebar-navigation .sidebar-item-text[href="index.qmd"]:hover,
#quarto-sidebar .sidebar-item-text[href="index.qmd"]:hover {
  background: linear-gradient(135deg, #1967d2 0%, #1557b0 100%) !important;
  transform: translateX(3px) translateY(-1px) !important;
  box-shadow: 0 6px 16px rgba(39, 128, 227, 0.4) !important;
  border-color: #1967d2 !important;
  color: white !important;
}

/* Ensure Home section chevron is visible and styled properly */
#quarto-sidebar .sidebar-item:has(.sidebar-item-text[href="index.qmd"]) .bi-chevron-right,
#quarto-sidebar .sidebar-item:has(.sidebar-item-text[href="index.qmd"]) .bi-chevron-down {
  color: white !important;
  opacity: 1 !important;
  display: inline-block !important;
  pointer-events: auto !important; /* Ensure chevron is clickable */
  cursor: pointer !important;
}

/* Ensure Home section children are properly styled and accessible */
#quarto-sidebar .sidebar-item:has(.sidebar-item-text[href="index.qmd"]) .sidebar-item .sidebar-item-text {
  /* Reset the special Home styling for child items */
  background: none !important;
  border: none !important;
  box-shadow: none !important;
  color: #4a5568 !important;
  font-weight: 500 !important;
  font-size: 0.9rem !important;
  padding: 0.3rem 0.75rem !important;
  padding-left: 1.5rem !important; /* Indent child items */
  border-radius: 4px !important;
  margin-bottom: 0.25rem !important;
  transform: none !important;
}

/* Home section children hover effect */
#quarto-sidebar .sidebar-item:has(.sidebar-item-text[href="index.qmd"]) .sidebar-item .sidebar-item-text:hover {
  background-color: rgba(237, 242, 247, 0.8) !important;
  color: #2d3748 !important;
  transform: none !important;
  box-shadow: none !important;
}

/* Ensure Home section can expand/collapse properly */
#quarto-sidebar .sidebar-item:has(.sidebar-item-text[href="index.qmd"]) .collapse {
  background: transparent !important;
}

/* Ensure icons work with emoji fallback */
.sidebar-navigation .sidebar-item-text {
    display: inline-flex;
    align-items: center;
}

/* FIXED: Left sidebar hierarchical indentation and spacing */
/* Reset all sidebar items to consistent baseline with proper spacing */
#quarto-sidebar .sidebar-item {
  margin-bottom: 0.4rem; /* Increased from 0.1rem for better separation */
}

/* Add extra spacing for top-level menu items */
#quarto-sidebar > .sidebar-navigation > .sidebar-item {
  margin-bottom: 0.6rem; /* More space between main sections */
}

/* Reduce spacing for nested items to maintain hierarchy */
#quarto-sidebar .sidebar-item .sidebar-item {
  margin-bottom: 0.25rem; /* Moderate spacing for first level nesting */
}

#quarto-sidebar .sidebar-item .sidebar-item .sidebar-item {
  margin-bottom: 0.15rem; /* Minimal spacing for deep nesting */
}

/* Base styling for all sidebar item texts */
#quarto-sidebar .sidebar-item-text {
  display: flex;
  align-items: center;
  gap: 0 !important; /* Remove the 0.5rem gap */
  line-height: 1.3;
  border-radius: 4px;
  transition: all 0.2s ease;
}

/* Level 0 (Root level): "Home", "Events", "Tools", etc. */
#quarto-sidebar > .sidebar-navigation > .sidebar-item > .sidebar-item-text {
  font-weight: 600 !important;
  font-size: 0.95rem !important;
  padding: 0.4rem 0.75rem !important;
  color: #2d3748 !important;
}

/* Level 1 (First nested): "Build Conference 2025", "Development Tools", etc. */
#quarto-sidebar .sidebar-item .sidebar-item > .sidebar-item-text {
  font-weight: 500 !important;
  font-size: 0.9rem !important;
  padding: 0.3rem 0.75rem !important;
  padding-left: 1.5rem !important; /* Indent from level 0 */
  color: #4a5568 !important;
}

/* Level 2 (Second nested): "Git Command Line", "HTTP Files Testing", etc. */
#quarto-sidebar .sidebar-item .sidebar-item .sidebar-item > .sidebar-item-text {
  font-weight: 400 !important;
  font-size: 0.85rem !important;
  padding: 0.25rem 0.75rem !important;
  padding-left: 2.25rem !important; /* Further indent from level 1 */
  color: #718096 !important;
}

/* Level 3 (Third nested): Deep nested items */
#quarto-sidebar .sidebar-item .sidebar-item .sidebar-item .sidebar-item > .sidebar-item-text {
  font-weight: 400 !important;
  font-size: 0.8rem !important;
  padding: 0.2rem 0.75rem !important;
  padding-left: 3rem !important; /* Further indent from level 2 */
  color: #a0aec0 !important;
}

/* Hover effects for better UX */
#quarto-sidebar .sidebar-item-text:hover {
  background-color: rgba(237, 242, 247, 0.8) !important;
}

/* Active state styling - hierarchical specificity */
#quarto-sidebar .sidebar-item-text.active {
  background-color: rgba(39, 128, 227, 0.1) !important;
  color: #2780e3 !important;
  border-left: 3px solid #2780e3 !important;
  padding-left: 0.75rem !important; /* Add space between border and text */
}

/* Ensure icons align properly at all levels */
#quarto-sidebar .sidebar-item-text i,
#quarto-sidebar .sidebar-item-text .bi {
  flex-shrink: 0;
  width: 1em;
  text-align: center;
  margin-right: 0.5rem !important;
}

/* Add padding to sidebar links for better spacing */
.sidebar-link,
#quarto-sidebar .nav-link,
#quarto-sidebar .sidebar-item-text {
  padding: 0.25rem 0 !important;
}

/* Collapse search component to minimize space */
.sidebar-search,
#quarto-search,
.mt-2.flex-shrink-0.align-items-center {
  max-height: 0 !important;
  overflow: hidden !important;
  opacity: 0 !important;
  margin: 0 !important;
  padding: 0 !important;
  border: none !important;
  transition: all 0.3s ease !important;
}

/* Fix sidebar alignment and remove unnecessary margins */
#quarto-sidebar {
  padding-top: 0 !important;
  margin-top: 0 !important;
}

/* Remove any unwanted spacing at the top of sidebar content */
#quarto-sidebar .sidebar-menu-container,
#quarto-sidebar .sidebar-navigation {
  margin-top: 0 !important;
  padding-top: 0 !important;
}

/* Make left sidebar align like right sidebar without breaking content */
#quarto-sidebar {
  position: sticky !important;
  top: 0 !important;
  align-self: flex-start !important;
  max-height: 100vh !important;
  overflow-y: auto !important;
}

/* Simulate the margin-sidebar wrapper div behavior */
#quarto-sidebar {
  /* Add the same margin-top that .sidebar.margin-sidebar has */
  margin-top: 1rem !important;
  margin-bottom: 1rem !important;
  padding: 0 !important;
  
  /* Wrapper div properties */
  display: block !important;
  width: auto !important;
  min-height: 0 !important;
  flex-shrink: 0 !important;
  box-sizing: border-box !important;
}

/* Ensure right sidebar has consistent behavior */
.quarto-margin-sidebar {
  margin-top: 1rem !important;
  padding-top: 0 !important;
}
</style>

<script>
// IMMEDIATE TEST - This should show up right away
console.log('🚀 SIDEBAR SCRIPT WITH HIERARCHICAL PERSISTENCE LOADING...');
console.log('Current time:', new Date().toLocaleTimeString());

// Clear localStorage for testing (uncomment to reset)
// localStorage.removeItem('learningHubSidebarState');
// console.log('🧹 Cleared existing localStorage for fresh start');

// Debug current localStorage content
const existingState = localStorage.getItem('learningHubSidebarState');
if (existingState) {
    console.log('📂 Existing localStorage state found:', JSON.parse(existingState));
} else {
    console.log('📂 No existing localStorage state found');
}

// Storage key for sidebar state
const SIDEBAR_STATE_KEY = 'learningHubSidebarState';

// Function to build hierarchical path for unique identification
function buildHierarchicalPath(element) {
    const path = [];
    let current = element;
    
    // Walk up the DOM tree to build the path
    while (current && !current.matches('#quarto-sidebar')) {
        if (current.matches('.sidebar-item')) {
            const textElement = current.querySelector('.sidebar-item-text');
            if (textElement) {
                const text = textElement.textContent?.trim();
                if (text) {
                    path.unshift(text); // Add to the beginning of the array
                }
            }
        }
        current = current.parentElement;
    }
    
    const finalPath = path.join(' > ') || 'unknown';
    return finalPath;
}

// Test if we can find the sidebar immediately
setTimeout(() => {
    const sidebar = document.getElementById('quarto-sidebar');
    console.log('🎯 Sidebar element found?', !!sidebar);
    if (sidebar) {
        console.log('📏 Sidebar HTML length:', sidebar.innerHTML.length);
        console.log('🔍 Sidebar children count:', sidebar.children.length);
    }
}, 100);

// Function to get all collapsible sections in the sidebar
function getCollapsibleSections() {
    const sidebar = document.getElementById('quarto-sidebar');
    if (!sidebar) return [];
    
    const sections = [];
    const chevrons = sidebar.querySelectorAll('.bi-chevron-right, .bi-chevron-down');
    
    console.log(`🔍 Found ${chevrons.length} chevron icons`);
    
    chevrons.forEach((chevron, index) => {
        const sidebarItem = chevron.closest('.sidebar-item');
        const sidebarText = sidebarItem?.querySelector('.sidebar-item-text');
        
        console.log(`Chevron ${index + 1}:`, {
            text: sidebarText?.textContent?.trim(),
            hasDataBsToggle: !!chevron.closest('[data-bs-toggle]'),
            hasDataBsTarget: !!chevron.closest('[data-bs-target]'),
            hasAriaExpanded: !!chevron.closest('[aria-expanded]'),
            chevronClasses: chevron.className
        });
        
        if (sidebarText && sidebarItem) {
            const text = sidebarText.textContent?.trim();
            const hierarchicalPath = buildHierarchicalPath(sidebarItem);
            
            // Check visibility of nested content
            const immediateChildren = Array.from(sidebarItem.children).filter(child => 
                child.classList && (child.classList.contains('sidebar-item') || child.classList.contains('sidebar-section'))
            );
            
            const nestedItems = sidebarItem.querySelectorAll(':scope > .sidebar-item, :scope > .sidebar-section, :scope .sidebar-item-container > .sidebar-item');
            
            const hasVisibleNestedContent = Array.from(nestedItems).some(item => {
                const computedStyle = window.getComputedStyle(item);
                return computedStyle.display !== 'none' && 
                       computedStyle.visibility !== 'hidden' &&
                       item.offsetHeight > 0 &&
                       item.offsetWidth > 0;
            });
            
            // Check Bootstrap collapse classes
            const parentCollapse = sidebarItem.querySelector('.collapse');
            const hasShowClass = parentCollapse ? parentCollapse.classList.contains('show') : false;
            
            // Check aria-expanded attribute
            const button = sidebarItem.querySelector('[aria-expanded]');
            const ariaExpanded = button ? button.getAttribute('aria-expanded') === 'true' : null;
            
            // Determine expanded state with priority
            let isExpanded;
            if (ariaExpanded !== null) {
                isExpanded = ariaExpanded;
            } else if (hasShowClass) {
                isExpanded = true;
            } else {
                isExpanded = hasVisibleNestedContent;
            }
            
            const safeId = hierarchicalPath
                .replace(/[^a-zA-Z0-9\s>/]/g, '')
                .replace(/\s+/g, '_')
                .replace(/>/g, '__')
                .substring(0, 100)
                .toLowerCase();
            
            sections.push({
                element: sidebarItem,
                text: text,
                hierarchicalPath: hierarchicalPath,
                chevron: chevron,
                isExpanded: isExpanded,
                id: safeId
            });
        }
    });
    
    console.log(`📋 Found ${sections.length} collapsible sections`);
    return sections;
}

// Save sidebar state to localStorage using hierarchical structure
function saveSidebarState() {
    console.log('💾🔍 saveSidebarState() called');
    try {
        const sections = getCollapsibleSections();
        const hierarchicalState = {};
        
        // First, preserve any existing Home state if it was manually set
        const existingSavedState = localStorage.getItem(SIDEBAR_STATE_KEY);
        let preserveHomeState = false;
        let preservedHomeState = null;
        
        if (existingSavedState) {
            try {
                const existing = JSON.parse(existingSavedState);
                if (existing.home && existing.home.hasOwnProperty('isExpanded')) {
                    // Check if the Home state was recently modified (within last 5 seconds)
                    const now = Date.now();
                    const lastHomeUpdate = existing.home.lastUpdate || 0;
                    const timeSince = now - lastHomeUpdate;
                    console.log('💾🔍 Home state check:', {
                        hasHome: !!existing.home,
                        isExpanded: existing.home.isExpanded,
                        lastUpdate: lastHomeUpdate,
                        timeSince: timeSince,
                        shouldPreserve: timeSince < 5000
                    });
                    if (timeSince < 5000) {
                        preserveHomeState = true;
                        preservedHomeState = existing.home;
                        console.log('💾 Preserving recently updated Home state:', preservedHomeState.isExpanded);
                    } else {
                        console.log('💾 Home state too old, not preserving (age:', timeSince, 'ms)');
                    }
                }
            } catch (e) {
                console.error('💾❌ Error parsing existing state:', e);
            }
        }
        
        sections.forEach(section => {
            console.log('💾🔍 Processing section:', section.text, 'isExpanded:', section.isExpanded);
            
            // Special handling for Home section
            if (section.text === 'Home' && preserveHomeState) {
                // Skip normal processing for Home if we're preserving its state
                const safeName = 'home';
                hierarchicalState[safeName] = preservedHomeState;
                console.log('💾 Preserved Home state instead of detecting:', preservedHomeState.isExpanded);
                return;
            } else if (section.text === 'Home') {
                console.log('💾 Processing Home normally (not preserving)');
            }
            
            // Build the path array from hierarchicalPath
            const pathParts = section.hierarchicalPath.split(' > ').map(part => 
                part.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '_').toLowerCase()
            );
            
            // Navigate/create the nested structure
            let current = hierarchicalState;
            pathParts.forEach((part, index) => {
                if (!current[part]) {
                    current[part] = {
                        text: section.hierarchicalPath.split(' > ')[index],
                        isExpanded: false,
                        children: {}
                    };
                }
                
                // If this is the final part, update with actual state
                if (index === pathParts.length - 1) {
                    current[part].isExpanded = section.isExpanded;
                    if (section.text === 'Home') {
                        console.log('💾 Set Home isExpanded to:', section.isExpanded, '(from section detection)');
                    }
                } else {
                    current = current[part].children;
                }
            });
        });
        
        localStorage.setItem(SIDEBAR_STATE_KEY, JSON.stringify(hierarchicalState));
        console.log(`💾 Saved state for ${sections.length} sections`);
        
    } catch (error) {
        console.error('❌ Failed to save sidebar state:', error);
    }
}

// Function to collapse all sections by default (eliminates flickering)
function collapseAllSectionsByDefault() {
    try {
        console.log('🔄 Collapsing all sections by default...');
        const sidebar = document.getElementById('quarto-sidebar');
        if (!sidebar) return;
        
        // Find all collapsible elements with .show class and remove it
        const openSections = sidebar.querySelectorAll('.collapse.show');
        let collapsedCount = 0;
        
        openSections.forEach(section => {
            // Remove the .show class to collapse the section
            section.classList.remove('show');
            collapsedCount++;
            
            // Also update aria-expanded to false
            const button = section.parentElement?.querySelector('[aria-expanded="true"]');
            if (button) {
                button.setAttribute('aria-expanded', 'false');
            }
            
            // Update chevron icons
            const chevron = section.parentElement?.querySelector('.bi-chevron-down');
            if (chevron) {
                chevron.classList.remove('bi-chevron-down');
                chevron.classList.add('bi-chevron-right');
            }
        });
        
        console.log(`🔽 Collapsed ${collapsedCount} sections by default`);
        return collapsedCount;
    } catch (error) {
        console.error('❌ Error collapsing sections:', error);
        return 0;
    }
}

// Restore sidebar state from localStorage using hierarchical structure
function restoreSidebarState() {
    try {
        const savedState = localStorage.getItem(SIDEBAR_STATE_KEY);
        if (!savedState) {
            console.log('📂 No saved sidebar state found');
            return;
        }
        
        const hierarchicalState = JSON.parse(savedState);
        console.log('🔄 Restoring sidebar state...');
        
        const sections = getCollapsibleSections();
        
        // Helper function to find state in nested structure
        function findStateInHierarchy(pathParts, state) {
            let current = state;
            for (const part of pathParts) {
                const safePart = part.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '_').toLowerCase();
                if (current[safePart]) {
                    current = current[safePart];
                    if (pathParts.indexOf(part) < pathParts.length - 1) {
                        current = current.children || {};
                    }
                } else {
                    return null; // Path not found
                }
            }
            return current;
        }
        
        let restoredCount = 0;
        sections.forEach(section => {
            console.log(`🔍 Checking section: "${section.text}" (path: ${section.hierarchicalPath})`);
            
            // Special handling for Home section
            if (section.text === 'Home') {
                console.log('🏠 Processing Home section restoration');
                const homeState = hierarchicalState['home'];
                if (homeState && homeState.isExpanded !== undefined) {
                    const shouldBeExpanded = homeState.isExpanded;
                    const isCurrentlyExpanded = section.isExpanded;
                    
                    console.log(`🏠 Home state - should be: ${shouldBeExpanded}, currently: ${isCurrentlyExpanded}`);
                    
                    if (shouldBeExpanded !== isCurrentlyExpanded) {
                        console.log('🏠 Restoring Home section state...');
                        setTimeout(() => {
                            // Find the collapse target manually like we do in the click handler
                            const homeItem = section.element;
                            let targetElement = homeItem?.querySelector('.collapse');
                            
                            if (!targetElement) {
                                const nextSibling = homeItem?.nextElementSibling;
                                if (nextSibling?.classList.contains('collapse')) {
                                    targetElement = nextSibling;
                                }
                            }
                            
                            if (targetElement) {
                                console.log('🏠 Found Home collapse target, applying state...');
                                if (shouldBeExpanded) {
                                    targetElement.classList.add('show');
                                    section.chevron.classList.remove('bi-chevron-right');
                                    section.chevron.classList.add('bi-chevron-down');
                                    console.log('🔽 Restored Home section to expanded');
                                } else {
                                    targetElement.classList.remove('show');
                                    section.chevron.classList.remove('bi-chevron-down');
                                    section.chevron.classList.add('bi-chevron-right');
                                    console.log('🔼 Restored Home section to collapsed');
                                }
                                restoredCount++;
                            } else {
                                console.log('❌ Could not find Home collapse target for restoration');
                            }
                        }, 200); // Slightly longer delay for Home section
                    }
                } else {
                    console.log('🏠 No saved state found for Home section');
                }
                return; // Skip normal processing for Home
            }
            
            // Normal processing for other sections
            const pathParts = section.hierarchicalPath.split(' > ');
            const savedSection = findStateInHierarchy(pathParts, hierarchicalState);
            
            if (savedSection) {
                const shouldBeExpanded = savedSection.isExpanded;
                const isCurrentlyExpanded = section.isExpanded;
                
                // If state doesn't match, click the chevron to toggle it
                if (shouldBeExpanded !== isCurrentlyExpanded) {
                    setTimeout(() => {
                        section.chevron.click();
                        restoredCount++;
                    }, 100);
                }
            }
        });
        
        if (restoredCount > 0) {
            console.log(`✅ Restored ${restoredCount} sections`);
        }
        
    } catch (error) {
        console.error('❌ Failed to restore sidebar state:', error);
    }
}

// Enhanced click detection with state saving
document.addEventListener('click', function(event) {
    // If it's in the sidebar, check if it's a chevron click
    if (event.target.closest('#quarto-sidebar')) {
        
        // Check if this is a chevron click (collapse/expand action)
        const isChevronClick = event.target.classList.contains('bi-chevron-right') || 
                              event.target.classList.contains('bi-chevron-down') ||
                              event.target.closest('.bi-chevron-right') ||
                              event.target.closest('.bi-chevron-down');
        
        // Check if this is any Bootstrap collapse trigger
        const isBootstrapTrigger = event.target.closest('[data-bs-toggle="collapse"]');
        
        if (isChevronClick || isBootstrapTrigger) {
            console.log('🔄 Sidebar collapse trigger clicked');
            
            // For Home section, let Bootstrap handle it naturally
            // Try multiple ways to find Home item (same logic as earlier)
            let homeItem = event.target.closest('.sidebar-item:has(.sidebar-item-text[href="index.qmd"])');
            if (!homeItem) {
                const homeLinks = Array.from(document.querySelectorAll('.sidebar-item-text') || []);
                const homeLink = homeLinks.find(link => link.textContent.trim() === 'Home');
                homeItem = homeLink?.closest('.sidebar-item');
            }
            if (!homeItem) {
                homeItem = event.target.closest('.sidebar-item:has(.sidebar-item-text[href*="localhost"])');
            }
            
            if (homeItem) {
                console.log('🏠 Home section collapse trigger clicked - letting Bootstrap handle it');
                
                // Don't interfere with Bootstrap, just log and save state after
                setTimeout(() => {
                    const collapseElement = homeItem.querySelector('.collapse');
                    const chevron = homeItem.querySelector('.bi-chevron-right, .bi-chevron-down');
                    console.log('🏠 After Bootstrap handling:', {
                        isExpanded: collapseElement?.classList.contains('show'),
                        chevronClass: chevron?.className
                    });
                }, 100);
            }
            
            // Wait for Bootstrap to update the DOM, then save state
            setTimeout(() => {
                saveSidebarState();
            }, 300);
        }
    }
});

// Also listen for Bootstrap collapse events specifically
document.addEventListener('shown.bs.collapse', function(event) {
    if (event.target.closest('#quarto-sidebar')) {
        console.log('📂 Bootstrap collapse shown event');
        saveSidebarState();
    }
});

document.addEventListener('hidden.bs.collapse', function(event) {
    if (event.target.closest('#quarto-sidebar')) {
        console.log('📁 Bootstrap collapse hidden event');
        saveSidebarState();
    }
});

// Initialize everything when page loads
setTimeout(() => {
    console.log('🔧 Initializing sidebar persistence...');
    
    // DEBUG: Check what's in localStorage first
    console.log('🔍 Checking localStorage contents...');
    const savedState = localStorage.getItem(SIDEBAR_STATE_KEY);
    if (savedState) {
        try {
            const parsed = JSON.parse(savedState);
            console.log('💾 Current localStorage state:', parsed);
            console.log('🏠 Home state in localStorage:', parsed.home);
        } catch (error) {
            console.error('❌ Error parsing localStorage:', error);
        }
    } else {
        console.log('📂 No localStorage state found');
    }
    
    // DEBUG: Check Home section structure - moved earlier
    console.log('🔍 Starting Home section analysis...');
    const sidebar = document.getElementById('quarto-sidebar');
    
    // Try multiple ways to find Home item
    let homeItem = sidebar?.querySelector('.sidebar-item:has(.sidebar-item-text[href="index.qmd"])');
    if (!homeItem) {
        // Try looking for Home by text content
        const homeLinks = Array.from(sidebar?.querySelectorAll('.sidebar-item-text') || []);
        const homeLink = homeLinks.find(link => link.textContent.trim() === 'Home');
        homeItem = homeLink?.closest('.sidebar-item');
    }
    if (!homeItem) {
        // Try looking for localhost URL
        homeItem = sidebar?.querySelector('.sidebar-item:has(.sidebar-item-text[href*="localhost"])');
    }
    
    const homeChevron = homeItem?.querySelector('.bi-chevron-right, .bi-chevron-down');
    const collapseTarget = homeItem?.querySelector('.collapse');
    
    console.log('🏠 Home section debug:', {
        sidebar: !!sidebar,
        homeItem: !!homeItem,
        homeChevron: !!homeChevron,
        collapseTarget: !!collapseTarget,
        chevronDataBsTarget: homeChevron?.closest('[data-bs-target]')?.getAttribute('data-bs-target'),
        collapseId: collapseTarget?.id,
        collapseClasses: collapseTarget?.className,
        homeItemOuterHTML: homeItem?.outerHTML.substring(0, 200) + '...'
    });
    
    // IMMEDIATE HOME FIX: Try direct approach
    if (homeChevron && !homeChevron.hasAttribute('data-home-fixed')) {
        console.log('🔧 Adding direct Home chevron handler');
        homeChevron.setAttribute('data-home-fixed', 'true');
        
        // Remove any existing listeners first
        const newChevron = homeChevron.cloneNode(true);
        homeChevron.parentNode.replaceChild(newChevron, homeChevron);
        
        newChevron.addEventListener('click', function(e) {
            try {
                console.log('🏠 HOME CHEVRON CLICKED!');
                console.log('🔍 Starting debug sequence...');
                
                console.log('🔍 Event target:', e.target);
                console.log('🔍 Event target classes:', e.target.className);
                console.log('🔍 Event target parent:', e.target.parentElement);
                
                e.preventDefault();
                e.stopPropagation();
                
                console.log('🔍 Prevented default and stopped propagation');
                
                const trigger = e.target.closest('[data-bs-target]');
                console.log('🎯 Closest trigger element:', trigger);
                
                if (trigger) {
                    console.log('🎯 Trigger classes:', trigger.className);
                    console.log('🎯 Trigger attributes:', trigger.attributes ? Array.from(trigger.attributes).map(attr => `${attr.name}="${attr.value}"`).join(', ') : 'none');
                } else {
                    console.log('❌ No trigger element found');
                }
                
                const targetSelector = trigger?.getAttribute('data-bs-target');
                console.log('🎯 Target selector:', targetSelector);
                
                if (targetSelector && targetSelector !== '#' && targetSelector.length > 1) {
                    console.log('✅ Valid target selector found, looking for element...');
                    const targetElement = document.querySelector(targetSelector);
                    console.log('🎯 Target element found:', !!targetElement);
                    console.log('🎯 Target element:', targetElement);
                    
                    if (targetElement) {
                        console.log('🎯 Target element classes:', targetElement.className);
                        const isExpanded = targetElement.classList.contains('show');
                        console.log('📊 Current state:', isExpanded ? 'expanded' : 'collapsed');
                        
                        console.log('� About to toggle state...');
                        if (isExpanded) {
                            targetElement.classList.remove('show');
                            e.target.classList.remove('bi-chevron-down');
                            e.target.classList.add('bi-chevron-right');
                            console.log('🔼 Collapsed Home section');
                        } else {
                            targetElement.classList.add('show');
                            e.target.classList.remove('bi-chevron-right');
                            e.target.classList.add('bi-chevron-down');
                            console.log('🔽 Expanded Home section');
                        }
                        
                        console.log('� Scheduling state save...');
                        setTimeout(saveSidebarState, 100);
                        console.log('✅ All operations completed');
                    } else {
                        console.log('❌ Target element not found for selector:', targetSelector);
                    }
                } else {
                    console.log('❌ Invalid or empty target selector:', targetSelector);
                    console.log('🔍 Attempting manual collapse target detection...');
                    
                    // Try to find the collapse element manually
                    const homeItem = e.target.closest('.sidebar-item');
                    let targetElement = homeItem?.querySelector('.collapse');
                    
                    if (!targetElement) {
                        // Look for a sibling collapse element
                        const nextSibling = homeItem?.nextElementSibling;
                        if (nextSibling?.classList.contains('collapse')) {
                            targetElement = nextSibling;
                        }
                    }
                    
                    console.log('🎯 Manual target element found:', !!targetElement);
                    console.log('🎯 Manual target element:', targetElement);
                    
                    if (targetElement) {
                        console.log('🎯 Manual target element classes:', targetElement.className);
                        const isExpanded = targetElement.classList.contains('show');
                        console.log('📊 Current state:', isExpanded ? 'expanded' : 'collapsed');
                        
                        console.log('🔄 About to toggle state...');
                        if (isExpanded) {
                            targetElement.classList.remove('show');
                            e.target.classList.remove('bi-chevron-down');
                            e.target.classList.add('bi-chevron-right');
                            console.log('🔼 Collapsed Home section');
                        } else {
                            targetElement.classList.add('show');
                            e.target.classList.remove('bi-chevron-right');
                            e.target.classList.add('bi-chevron-down');
                            console.log('🔽 Expanded Home section');
                        }
                        
                        // IMPORTANT: Force state save immediately for Home section
                        console.log('💾 Force saving Home state immediately...');
                        setTimeout(() => {
                            const newState = !isExpanded; // The new expanded state
                            console.log('💾 Home new state should be:', newState);
                            
                            // Get current state from localStorage
                            const currentSavedState = localStorage.getItem(SIDEBAR_STATE_KEY);
                            if (currentSavedState) {
                                try {
                                    const parsedState = JSON.parse(currentSavedState);
                                    parsedState.home = parsedState.home || {};
                                    parsedState.home.isExpanded = newState;
                                    parsedState.home.text = 'Home';
                                    parsedState.home.lastUpdate = Date.now(); // Add timestamp
                                    parsedState.home.children = parsedState.home.children || {};
                                    localStorage.setItem(SIDEBAR_STATE_KEY, JSON.stringify(parsedState));
                                    console.log('💾✅ Home state force-saved as:', newState, 'with timestamp');
                                } catch (error) {
                                    console.error('💾❌ Error force-saving Home state:', error);
                                }
                            }
                            
                            // Also trigger the normal state saving
                            saveSidebarState();
                        }, 100);
                        console.log('✅ Manual operations completed');
                    } else {
                        console.log('❌ No collapse target found manually either');
                        console.log('🔍 Available collapse elements in sidebar:');
                        const allCollapses = document.querySelectorAll('#quarto-sidebar .collapse');
                        allCollapses.forEach((el, i) => {
                            console.log(`  Collapse ${i}: id="${el.id}" classes="${el.className}"`);
                        });
                    }
                }
                
            } catch (error) {
                console.error('💥 ERROR in Home chevron handler:', error);
                console.error('💥 Error stack:', error.stack);
            }
        });
        
        console.log('✅ Home chevron handler added');
    } else if (homeChevron && homeChevron.hasAttribute('data-home-fixed')) {
        console.log('⚠️ Home chevron already has handler');
    } else {
        console.log('❌ Home chevron not found');
        // Debug: Let's see what we can find
        console.log('🔍 Available sidebar items:');
        const allItems = sidebar?.querySelectorAll('.sidebar-item') || [];
        allItems.forEach((item, index) => {
            const link = item.querySelector('.sidebar-item-text');
            const chevron = item.querySelector('.bi-chevron-right, .bi-chevron-down');
            console.log(`  Item ${index}: "${link?.textContent?.trim()}" href="${link?.href}" hasChevron=${!!chevron}`);
        });
    }
    
    // STEP 1: Collapse all sections by default (eliminates flickering)
    setTimeout(() => {
        collapseAllSectionsByDefault();
    }, 200);
    
    // STEP 2: Then restore only the previously opened sections
    setTimeout(() => {
        restoreSidebarState();
    }, 500);
    
    // STEP 3: Save initial state after restoration
    setTimeout(() => {
        saveSidebarState();
    }, 1500);
    
}, 1000);

// Save state when page unloads
window.addEventListener('beforeunload', function() {
    saveSidebarState();
});

console.log('✅ Sidebar persistence system initialized');
</script>
