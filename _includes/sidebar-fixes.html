<!-- Sidebar styling and fixes -->
<style>
/* Home link special styling - make it white and prominent */
.sidebar .nav-link[href="index.qmd"],
.sidebar .sidebar-item-text[href="index.qmd"],
.sidebar a[href="index.qmd"],
.sidebar-navigation .sidebar-item-text[href="index.qmd"],
#quarto-sidebar .sidebar-item-text[href="index.qmd"] {
  font-weight: 600 !important;
  font-size: 1.1rem !important;
  color: white !important;
  background: linear-gradient(135deg, #2780e3 0%, #1967d2 100%) !important;
  border: 2px solid #2780e3 !important;
  margin-bottom: 1rem !important;
  padding: 0.8rem 1rem !important;
  border-radius: 12px !important;
  box-shadow: 0 3px 8px rgba(39, 128, 227, 0.3) !important;
  transition: all 0.3s ease !important;
  display: block !important;
}

.sidebar .nav-link[href="index.qmd"]:hover,
.sidebar .sidebar-item-text[href="index.qmd"]:hover,
.sidebar a[href="index.qmd"]:hover,
.sidebar-navigation .sidebar-item-text[href="index.qmd"]:hover,
#quarto-sidebar .sidebar-item-text[href="index.qmd"]:hover {
  background: linear-gradient(135deg, #1967d2 0%, #1557b0 100%) !important;
  transform: translateX(3px) translateY(-1px) !important;
  box-shadow: 0 6px 16px rgba(39, 128, 227, 0.4) !important;
  border-color: #1967d2 !important;
  color: white !important;
}

/* Ensure sidebar icons work with emoji fallback */
.sidebar-navigation .sidebar-item-text {
    display: inline-flex;
    align-items: center;
}

/* FIXED: Left sidebar hierarchical indentation and spacing */
/* Reset all sidebar items to consistent baseline */
#quarto-sidebar .sidebar-item {
  margin-bottom: 0.1rem;
}

/* Base styling for all sidebar item texts */
#quarto-sidebar .sidebar-item-text {
  display: flex;
  align-items: center;
  gap: 0 !important; /* Remove the 0.5rem gap */
  line-height: 1.3;
  border-radius: 4px;
  transition: all 0.2s ease;
}

/* Level 0 (Root level): "Home", "Events", "Tools", etc. */
#quarto-sidebar > .sidebar-navigation > .sidebar-item > .sidebar-item-text {
  font-weight: 600 !important;
  font-size: 0.95rem !important;
  padding: 0.4rem 0.75rem !important;
  color: #2d3748 !important;
}

/* Level 1 (First nested): "Build Conference 2025", "Development Tools", etc. */
#quarto-sidebar .sidebar-item .sidebar-item > .sidebar-item-text {
  font-weight: 500 !important;
  font-size: 0.9rem !important;
  padding: 0.3rem 0.75rem !important;
  padding-left: 1.5rem !important; /* Indent from level 0 */
  color: #4a5568 !important;
}

/* Level 2 (Second nested): "Git Command Line", "HTTP Files Testing", etc. */
#quarto-sidebar .sidebar-item .sidebar-item .sidebar-item > .sidebar-item-text {
  font-weight: 400 !important;
  font-size: 0.85rem !important;
  padding: 0.25rem 0.75rem !important;
  padding-left: 2.25rem !important; /* Further indent from level 1 */
  color: #718096 !important;
}

/* Level 3 (Third nested): Deep nested items */
#quarto-sidebar .sidebar-item .sidebar-item .sidebar-item .sidebar-item > .sidebar-item-text {
  font-weight: 400 !important;
  font-size: 0.8rem !important;
  padding: 0.2rem 0.75rem !important;
  padding-left: 3rem !important; /* Further indent from level 2 */
  color: #a0aec0 !important;
}

/* Hover effects for better UX */
#quarto-sidebar .sidebar-item-text:hover {
  background-color: rgba(237, 242, 247, 0.8) !important;
}

/* Active state styling - hierarchical specificity */
#quarto-sidebar .sidebar-item-text.active {
  background-color: rgba(39, 128, 227, 0.1) !important;
  color: #2780e3 !important;
  border-left: 3px solid #2780e3 !important;
}

/* Override any conflicting container-based rules */
#quarto-sidebar .sidebar-item-container .sidebar-item-text,
#quarto-sidebar .sidebar-section .sidebar-item-text {
  /* Reset any container-specific padding - let hierarchy rules take precedence */
  padding: inherit !important;
}

/* Ensure icons align properly at all levels */
#quarto-sidebar .sidebar-item-text i,
#quarto-sidebar .sidebar-item-text .bi {
  flex-shrink: 0;
  width: 1em;
  text-align: center;
  margin-right: 0.5rem !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Sidebar fixes script loaded');
    
    setTimeout(function() {
        // Fix sidebar Home link styling
        const sidebarHomeLinks = document.querySelectorAll(
            '.sidebar a[href*="index"], #quarto-sidebar a[href*="index"], .sidebar-item-text[href*="index"]'
        );
        sidebarHomeLinks.forEach(link => {
            if (link.textContent.trim().toLowerCase().includes('home')) {
                console.log('Applying white styling to Home link in sidebar');
                link.style.setProperty('color', 'white', 'important');
                link.style.setProperty('background', 'linear-gradient(135deg, #2780e3 0%, #1967d2 100%)', 'important');
                link.style.setProperty('border', '2px solid #2780e3', 'important');
                link.style.setProperty('border-radius', '12px', 'important');
                link.style.setProperty('padding', '0.8rem 1rem', 'important');
                link.style.setProperty('font-weight', '600', 'important');
                link.style.setProperty('box-shadow', '0 3px 8px rgba(39, 128, 227, 0.3)', 'important');
                link.style.setProperty('margin-bottom', '1rem', 'important');
                link.classList.add('home-link-styled');
                
                // Add home icon if missing
                if (!link.querySelector('.bi-house-fill')) {
                    const homeIcon = document.createElement('i');
                    homeIcon.className = 'bi bi-house-fill';
                    homeIcon.style.marginRight = '0.75rem';
                    homeIcon.style.color = 'white';
                    link.prepend(homeIcon);
                }
            }
        });

        // Initialize persistent sidebar state
        initPersistentSidebar();
    }, 1000);
});

// Persistent Sidebar State Management
function initPersistentSidebar() {
    console.log('Initializing persistent sidebar state...');
    
    // Storage key for sidebar state
    const SIDEBAR_STATE_KEY = 'learningHubSidebarState';
    
    // Get all collapsible sidebar items (those with expand/collapse functionality)
    function getSidebarItems() {
        // Look for Quarto sidebar items with toggle functionality
        return document.querySelectorAll('#quarto-sidebar .sidebar-item-container, #quarto-sidebar .sidebar-item[data-bs-toggle]');
    }
    
    // Generate unique identifier for each sidebar item
    function getItemId(item) {
        // Try to find a text identifier from the item
        const textElement = item.querySelector('.sidebar-item-text');
        if (textElement) {
            const text = textElement.textContent.trim().substring(0, 50); // First 50 chars
            const href = textElement.getAttribute('href') || '';
            return btoa(text + href).replace(/[^a-zA-Z0-9]/g, ''); // Base64 encode and clean
        }
        return null;
    }
    
    // Save current sidebar state to localStorage
    function saveSidebarState() {
        const state = {};
        const sidebarItems = getSidebarItems();
        
        sidebarItems.forEach(item => {
            const id = getItemId(item);
            if (id) {
                // Check if item is expanded/collapsed
                const isCollapsed = item.classList.contains('collapsed') || 
                                  item.getAttribute('aria-expanded') === 'false' ||
                                  (item.querySelector('.sidebar-section') && 
                                   item.querySelector('.sidebar-section').style.display === 'none');
                state[id] = {
                    collapsed: isCollapsed,
                    text: item.querySelector('.sidebar-item-text')?.textContent?.trim().substring(0, 30) || 'Unknown'
                };
            }
        });
        
        try {
            localStorage.setItem(SIDEBAR_STATE_KEY, JSON.stringify(state));
            console.log('Sidebar state saved:', state);
        } catch (error) {
            console.error('Failed to save sidebar state:', error);
        }
    }
    
    // Restore sidebar state from localStorage
    function restoreSidebarState() {
        try {
            const savedState = localStorage.getItem(SIDEBAR_STATE_KEY);
            if (!savedState) {
                console.log('No saved sidebar state found');
                return;
            }
            
            const state = JSON.parse(savedState);
            console.log('Restoring sidebar state:', state);
            
            const sidebarItems = getSidebarItems();
            
            sidebarItems.forEach(item => {
                const id = getItemId(item);
                if (id && state[id]) {
                    const shouldBeCollapsed = state[id].collapsed;
                    
                    // Find the toggle button or clickable element
                    const toggleButton = item.querySelector('.sidebar-item-text[data-bs-toggle]') ||
                                       item.querySelector('[data-bs-toggle]') ||
                                       item.querySelector('.sidebar-item-text');
                    
                    if (toggleButton) {
                        // If the current state doesn't match desired state, trigger click
                        const isCurrentlyCollapsed = item.classList.contains('collapsed') || 
                                                   item.getAttribute('aria-expanded') === 'false';
                        
                        if (isCurrentlyCollapsed !== shouldBeCollapsed) {
                            setTimeout(() => {
                                toggleButton.click();
                                console.log(`Restored state for "${state[id].text}": ${shouldBeCollapsed ? 'collapsed' : 'expanded'}`);
                            }, 100);
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Failed to restore sidebar state:', error);
        }
    }
    
    // Add event listeners to track sidebar changes
    function attachSidebarListeners() {
        // Listen for Bootstrap collapse events
        document.addEventListener('click', function(event) {
            // Check if clicked element is a sidebar toggle
            const target = event.target.closest('.sidebar-item-text, [data-bs-toggle]');
            if (target && target.closest('#quarto-sidebar')) {
                // Wait a bit for the collapse animation to complete
                setTimeout(saveSidebarState, 300);
            }
        });
        
        // Also listen for Bootstrap's native collapse events
        document.addEventListener('shown.bs.collapse', saveSidebarState);
        document.addEventListener('hidden.bs.collapse', saveSidebarState);
        
        // Backup: periodic save in case we miss some events
        setInterval(saveSidebarState, 10000); // Save every 10 seconds
    }
    
    // Initialize the persistent sidebar functionality
    setTimeout(() => {
        restoreSidebarState();
        attachSidebarListeners();
        
        // Save initial state
        setTimeout(saveSidebarState, 2000);
    }, 500);
    
    // Save state when page is about to be unloaded
    window.addEventListener('beforeunload', saveSidebarState);
    window.addEventListener('pagehide', saveSidebarState);
    
    console.log('Persistent sidebar state initialized');
}
</script>