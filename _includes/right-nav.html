<div id="custom-right-nav" style="display: none;">
  <div class="toc-title">Related Pages</div>
  <nav class="toc" role="doc-toc">
    <ul>
      <li><em>Loading...</em></li>
    </ul>
  </nav>
</div>

<style>
/* Professional Related Pages navigation styling - RIGHT SIDEBAR ONLY */
#custom-right-nav {
  width: 100%;
  background: #f8f9fa;
  border: 1px solid #e9ecef;
  border-radius: 6px;
  padding: 12px;
  margin-top: 2rem; /* Add spacing from native TOC */
  font-size: 0.9rem;
  max-height: 60vh; /* Reduced from 70vh to leave space for native TOC */
  overflow-y: auto;
  scroll-behavior: smooth;
}

/* Ensure our custom nav doesn't interfere with native TOC styling */
#custom-right-nav.custom-navigation {
  background: #f0f8ff; /* Slightly different background to distinguish from native TOC */
  border-color: #2780e3;
}

#custom-right-nav .toc-title {
  font-weight: 600;
  font-size: 1rem;
  color: #2780e3;
  margin-bottom: 12px;
  padding-bottom: 6px;
  border-bottom: 2px solid #2780e3;
}

/* Ensure native TOC is not affected by our styles */
#TOC, 
.table-of-contents:not(#custom-right-nav .table-of-contents),
nav[role="doc-toc"]:not(#custom-right-nav nav) {
  margin-bottom: 1rem !important;
}

/* Styling for section labels in Related Pages */
.nav-section-label {
  display: block;
  padding: 0.25rem 0;
  color: #2780e3;
  font-weight: 600;
  text-decoration: none;
}

/* Styling for navigation links in Related Pages */
#custom-right-nav .nav-link {
  display: block;
  padding: 0.25rem 0;
  color: #495057;
  text-decoration: none;
  border-radius: 3px;
  transition: all 0.2s ease;
}

#custom-right-nav .nav-link:hover {
  color: #2780e3;
  text-decoration: none;
  background-color: rgba(39, 128, 227, 0.1);
  padding-left: 0.5rem;
}

/* Active (current page) styling in Related Pages */
#custom-right-nav .nav-link.active {
  color: #2780e3;
  font-weight: 600;
  background-color: rgba(39, 128, 227, 0.15);
  padding-left: 0.5rem;
  border-left: 3px solid #2780e3;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  console.log('üìã Related Pages loading...');
  
  // Global navigation structure from navigation.json
  let navigationConfig = null;
  
  // Wrap everything in try-catch to prevent other JS errors from breaking this
  try {
    // Load navigation configuration - SIMPLIFIED
    async function loadNavigationConfig() {
      try {
        let navUrl = window.location.href.includes('darioairoldi.github.io/Learn') 
          ? 'https://darioairoldi.github.io/Learn/navigation.json'
          : window.location.origin + '/navigation.json';
        
        console.log('üîÑ Loading navigation from:', navUrl);
        
        const response = await fetch(navUrl);
        
        if (response.ok && response.headers.get('content-type')?.includes('application/json')) {
          navigationConfig = await response.json();
          console.log('‚úÖ Navigation config loaded');
          renderRightNav();
        } else {
          console.log('‚ö†Ô∏è Navigation config failed (status:', response.status, '), using DOM parsing');
          renderRightNav();
        }
      } catch (error) {
        console.log('‚ö†Ô∏è Navigation config error:', error.message, '- using DOM parsing');
        renderRightNav();
      }
    }
    
    // Handle responsive layout function
    function handleResponsiveLayout() {
      const customNav = document.querySelector('#custom-right-nav');
      if (!customNav) return;
      
      const isMobile = window.innerWidth <= 800;
      
      if (isMobile) {
        customNav.style.display = 'none';
      } else if (customNav.classList.contains('has-content')) {
        customNav.style.display = 'block';
      }
    }
    
    // Initialize right navigation - SIMPLIFIED
    function initializeRightNav() {
      setTimeout(() => {
        createCustomRightNav();
        handleResponsiveLayout();
        loadNavigationConfig();
      }, 300);
    }
    
    // Try immediately for any page
    initializeRightNav();
    
    // Also try when the page is fully loaded
    window.addEventListener('load', function() {
      setTimeout(renderRightNav, 200);
    });
    
    // Handle window resize
    window.addEventListener('resize', handleResponsiveLayout);
    
    // Listen for sidebar clicks to trigger updates
    document.addEventListener('click', function(event) {
      try {
        const sidebarItem = event.target.closest('.sidebar-item-text, .nav-link');
        if (sidebarItem && sidebarItem.closest('#quarto-sidebar')) {
          setTimeout(renderRightNav, 100);
        }
      } catch (error) {
        console.error('‚ùå Error in click handler:', error);
      }
    });
    
    // Get current page path - SIMPLIFIED VERSION
    function getCurrentPagePath() {
      try {
        let path = window.location.pathname;
        
        if (path === '/' || path === '') {
          return 'index';
        }
        
        // Remove leading slash and decode URI components
        path = path.replace(/^\//, '');
        try {
          path = decodeURIComponent(path);
        } catch (e) {
          console.log('‚ö†Ô∏è URI decoding failed');
        }
        
        // Remove .html extension and normalize
        path = path.replace('.html', '');
        
        // For GitHub Pages, remove the repo name prefix if present
        if (path.startsWith('Learn/')) {
          path = path.substring(5); // Remove "Learn/"
        }
        
        console.log('üîç Current page path:', path);
        return path;
      } catch (error) {
        console.error('‚ùå Error in getCurrentPagePath:', error);
        return '';
      }
    }
    
    // SIMPLIFIED: Find current page in navigation - NO MORE MASSIVE RECURSIVE SEARCH
    function findCurrentPageSiblings() {
      try {
        if (navigationConfig && navigationConfig.contents) {
          console.log('‚úÖ Using navigation.json configuration');
          const currentPath = getCurrentPagePath();
          
          // DIRECT SEARCH - no more recursive madness
          const result = findDirectMatch(navigationConfig.contents, currentPath);
          if (result) {
            const { item, parent } = result;
            
            if (item.contents && item.contents.length > 0) {
              // This is a section - show ALL children (sections preferred)
              console.log('üìÇ Section - showing children:', item.contents.length);
              const sections = item.contents.filter(child => child.section);
              const children = sections.length > 0 ? sections : item.contents.filter(child => child.text && child.href);
              
              return children.map(child => ({
                text: child.text || child.section,
                href: child.href || '#',
                isActive: false,
                isSection: !!child.section
              }));
            } else if (parent && parent.contents) {
              // This is a leaf - show ALL siblings including current
              console.log('üìÑ Leaf - showing siblings:', parent.contents.length);
              return parent.contents
                .filter(sibling => sibling.href && sibling.href !== '#')
                .map(sibling => ({
                  text: sibling.text || sibling.section,
                  href: sibling.href,
                  isActive: pathsMatch(sibling.href, currentPath),
                  isSection: !!sibling.section
                }));
            }
          }
        }
        
        console.log('‚ö†Ô∏è Using DOM parsing fallback');
        return findSiblingsFromDOM();
      } catch (error) {
        console.error('‚ùå Error in findCurrentPageSiblings:', error);
        return [];
      }
    }
    
    // SIMPLIFIED: Direct match finder - NO MORE RECURSIVE NIGHTMARE
    function findDirectMatch(items, targetPath, parent = null) {
      for (const item of items) {
        if (item.href && pathsMatch(item.href, targetPath)) {
          // Prioritize sections over leafs
          if (item.section && item.contents) {
            console.log('‚úÖ Found SECTION match:', item.section);
            return { item, parent };
          } else {
            console.log('‚úÖ Found LEAF match:', item.text);
            return { item, parent };
          }
        }
        
        // Only search in direct children, not deep recursion
        if (item.contents) {
          const found = findDirectMatch(item.contents, targetPath, item);
          if (found) return found;
        }
      }
      return null;
    }
    
    // SIMPLIFIED: Path matching - MUCH CLEANER
    function pathsMatch(configPath, currentPath) {
      if (!configPath || !currentPath) return false;
      
      const normalize = (path) => {
        return path.toLowerCase()
          .replace(/\\/g, '/')
          .replace(/\.(md|html|qmd)$/, '')
          .replace(/^\/+/, '')
          .replace(/\/+$/, '')
          .trim();
      };
      
      const normalizedConfig = normalize(configPath);
      const normalizedCurrent = normalize(currentPath);
      
      // Direct match or current ends with config
      return normalizedConfig === normalizedCurrent || 
             normalizedCurrent.endsWith(normalizedConfig);
    }
    
    // Fallback DOM parsing - UPDATED TO SHOW FIRST-LEVEL SECTIONS
    function findSiblingsFromDOM() {
      const sidebar = document.querySelector('#quarto-sidebar');
      if (!sidebar) return [];
      
      const activeItem = sidebar.querySelector('.sidebar-item-text.active');
      if (!activeItem) return [];
      
      console.log('üîç DOM: Active item found:', activeItem.textContent.trim());
      
      const activeContainer = activeItem.closest('.sidebar-item');
      if (!activeContainer) return [];
      
      // Check if the current page is a section page (has child sections)
      const currentSectionContainer = activeContainer.querySelector('.sidebar-item-container');
      
      console.log('üîç DOM: Section container exists:', !!currentSectionContainer);
      
      if (currentSectionContainer) {
        // This is a section page - show first-level child sections only
        console.log('üìÇ DOM: Section page detected - showing first-level children');
        
        const siblings = [];
        
        // Try multiple selectors to find direct children
        const directChildrenSelectors = [
          ':scope > .sidebar-item',
          '.sidebar-item'
        ];
        
        let directChildren = [];
        for (const selector of directChildrenSelectors) {
          directChildren = currentSectionContainer.querySelectorAll(selector);
          if (directChildren.length > 0) {
            console.log(`üîç DOM: Found ${directChildren.length} children using selector: ${selector}`);
            break;
          }
        }
        
        if (directChildren.length === 0) {
          // Alternative approach: look for any links within the section container
          directChildren = currentSectionContainer.querySelectorAll('.sidebar-item-text[href]');
          console.log(`üîç DOM: Found ${directChildren.length} direct links in section`);
        }
        
        directChildren.forEach((child, index) => {
          console.log(`üîç DOM: Processing child ${index + 1}:`, child);
          
          // Try to find the link within the child
          let childLink = null;
          if (child.classList && child.classList.contains('sidebar-item-text')) {
            childLink = child;
          } else {
            childLink = child.querySelector('.sidebar-item-text[href]');
          }
          
          if (childLink) {
            const href = childLink.getAttribute('href');
            const text = childLink.textContent.trim();
            
            console.log(`üîç DOM: Child link - text: "${text}", href: "${href}"`);
            
            if (href && href !== '#' && text) {
              // Check if this child also has subsections (making it a section)
              const hasSubsections = child.querySelector ? child.querySelector('.sidebar-item-container') : false;
              
              siblings.push({
                text: text,
                href: href,
                isActive: childLink.classList.contains('active'),
                isSection: !!hasSubsections
              });
              
              console.log(`‚úÖ DOM: Added sibling: "${text}"`);
            }
          }
        });
        
        console.log('üìÇ DOM: Found first-level children:', siblings.map(s => s.text));
        return siblings;
      } else {
        // This is a leaf page - show ALL siblings including current at the same level
        console.log('üìÑ DOM: Leaf page detected - showing ALL siblings (including current)');
        
        const parentContainer = activeContainer.parentElement;
        if (!parentContainer) return [];
        
        const siblings = [];
        const siblingItems = parentContainer.querySelectorAll(':scope > .sidebar-item .sidebar-item-text[href]');
        
        siblingItems.forEach(item => {
          const href = item.getAttribute('href');
          if (href && href !== '#') {
            siblings.push({
              text: item.textContent.trim(),
              href: href,
              isActive: item.classList.contains('active'),
              isSection: false
            });
          }
        });
        
        console.log('üìÑ DOM: Found ALL siblings (including current):', siblings.map(s => s.text));
        console.log('üìÑ DOM: Active sibling marked:', siblings.filter(s => s.isActive).map(s => s.text));
        return siblings;
      }
    }

    function createCustomRightNav() {
      try {
        console.log('üèóÔ∏è Creating custom right nav...');
        
        // Find right sidebar container
        const containerSelectors = [
          '#quarto-margin-sidebar',
          '.margin-sidebar', 
          '#quarto-sidebar-toc'
        ];
        
        let targetContainer = null;
        for (const selector of containerSelectors) {
          const found = document.querySelector(selector);
          if (found) {
            targetContainer = found;
            console.log('‚úÖ Found right sidebar container:', selector);
            break;
          }
        }

        if (!targetContainer) {
          console.log('‚ö†Ô∏è Creating fallback right sidebar container...');
          const rightSidebarContainer = document.createElement('div');
          rightSidebarContainer.id = 'custom-margin-sidebar';
          rightSidebarContainer.style.cssText = `
            position: fixed;
            right: 20px;
            top: 100px;
            width: 250px;
            max-height: 60vh;
            overflow-y: auto;
            z-index: 1000;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          `;
          document.body.appendChild(rightSidebarContainer);
          targetContainer = rightSidebarContainer;
          console.log('‚úÖ Created fallback container');
        }

        // Remove existing custom nav
        const existing = document.querySelector('#custom-right-nav');
        if (existing) {
          existing.remove();
        }

        // Preserve existing TOC
        const existingToc = targetContainer.querySelector('#TOC, .table-of-contents, nav[role="doc-toc"]:not(#custom-right-nav nav)');
        if (existingToc) {
          console.log('‚úÖ Preserving existing Quarto TOC');
        }

        // Create the custom nav element
        const customNav = document.createElement('div');
        customNav.id = 'custom-right-nav';
        customNav.className = 'toc-right custom-navigation';
        customNav.innerHTML = `
          <div class="toc-title">Related Pages</div>
          <nav class="toc" role="doc-toc">
            <ul>
              <li><em>Loading...</em></li>
            </ul>
          </nav>
        `;

        // Insert after existing TOC or append to container
        if (existingToc) {
          customNav.style.marginTop = '2rem';
          existingToc.parentNode.insertBefore(customNav, existingToc.nextSibling);
        } else {
          targetContainer.appendChild(customNav);
        }

        console.log('‚úÖ Custom nav created');
        
        // Render content immediately
        setTimeout(renderRightNav, 100);
      } catch (error) {
        console.error('‚ùå Error in createCustomRightNav:', error);
      }
    }
    
    // OPTIMIZED: Render only sibling pages, not entire navigation tree - UPDATED WITH SECTION SUPPORT
    function renderRightNav() {
      try {
        const customNav = document.querySelector('#custom-right-nav');
        if (!customNav) return;
        
        const siblings = findCurrentPageSiblings();
        const navContainer = customNav.querySelector('.toc > ul');
        
        if (!navContainer) return;
        
        // Clear existing content
        navContainer.innerHTML = '';
        
        if (!siblings || siblings.length === 0) {
          navContainer.innerHTML = '<li><em>No related pages found</em></li>';
          console.log('üìÑ No related pages to show');
          return;
        }
        
        // Render sibling pages
        siblings.forEach(sibling => {
          const listItem = document.createElement('li');
          listItem.className = 'nav-item';
          
          if (sibling.isSection && sibling.href === '#') {
            // This is a section without a direct link - make it a label
            const span = document.createElement('span');
            span.textContent = sibling.text;
            span.className = 'nav-section-label';
            listItem.appendChild(span);
          } else {
            // This is a regular link
            const link = document.createElement('a');
            link.href = sibling.href;
            link.textContent = sibling.text;
            link.className = 'nav-link';
            
            if (sibling.isActive) {
              // Active link styling
              link.classList.add('active');
            }
            
            listItem.appendChild(link);
          }
          
          navContainer.appendChild(listItem);
        });
        
        customNav.classList.add('has-content');
        console.log('‚úÖ Rendered right nav with', siblings.length, 'items');
      } catch (error) {
        console.error('‚ùå Error in renderRightNav:', error);
      }
    }
  } catch (error) {
    console.error('‚ùå Error in Related Pages navigation script:', error);
  }
});
</script>